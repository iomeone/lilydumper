<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>File format - Lilyplayer's documentation</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <base href="">

        <link rel="stylesheet" href="book.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="_FontAwesome/css/font-awesome.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        

    </head>
    <body class="light">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = 'light'; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li class="affix"><a href="intro.html">Introduction</a></li><li><a href="finding_when_notes_are_played.html"><strong aria-hidden="true">1.</strong> Finding when notes are played</a></li><li><ol class="section"><li><a href="issue_with_tied_notes.html"><strong aria-hidden="true">1.1.</strong> Tied notes</a></li><li><a href="issue_with_grace_notes.html"><strong aria-hidden="true">1.2.</strong> Grace notes</a></li><li><a href="issue_with_repeats.html"><strong aria-hidden="true">1.3.</strong> Repeats</a></li><li><a href="issue_with_overlapping_notes.html"><strong aria-hidden="true">1.4.</strong> Fixing overlapping notes</a></li><li><a href="issue_with_repeated_notes.html"><strong aria-hidden="true">1.5.</strong> Separating repeated notes</a></li></ol></li><li><a href="computing_the_cursor_position.html"><strong aria-hidden="true">2.</strong> Finding where the cursor should be</a></li><li><ol class="section"><li><a href="matching_a_note_to_where_it_appears.html"><strong aria-hidden="true">2.1.</strong> Finding where notes appear on the music sheet</a></li><li><a href="finding_systems_top_and_bottom.html"><strong aria-hidden="true">2.2.</strong> Finding the top and bottom of systems</a></li><li><a href="getting_the_cursor_wrapping_all_notes_belonging_to_a_chord.html"><strong aria-hidden="true">2.3.</strong> Cursor for notes in a chord</a></li></ol></li><li><a href="finding_bar_changes.html"><strong aria-hidden="true">3.</strong> Finding bar changes events</a></li><li><a href="finding_turn_page_changes.html"><strong aria-hidden="true">4.</strong> Finding turn page events</a></li><li><a href="finding_on_which_stave_a_note_is.html"><strong aria-hidden="true">5.</strong> Left/right hand separation</a></li><li><a href="finding_the_staff_instrument_name.html"><strong aria-hidden="true">6.</strong> Getting the staff's instrument name</a></li><li><a href="file_format.html" class="active"><strong aria-hidden="true">7.</strong> File format</a></li><li><a href="possible_improvements.html"><strong aria-hidden="true">8.</strong> Possible improvements</a></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light <span class="default">(default)</span></button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Lilyplayer's documentation</h1> 

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="file_format.html#file-format" id="file-format"><h1>File format</h1></a>
<p>The whole process described up to here takes time. To give you an idea, it takes about 20 seconds to analyse
the music sheet &quot;FÃ¼r Elise&quot; from Beethoven. Surely, having to wait 20 seconds every time one wants to listen
to that song is simply not acceptable. Also, since this computation gives always the same result, one can
simply compute the whole thing once, and then save the result somewhere to later reuse.</p>
<p>This chapter describe the file format used, so that applications reading these files can be built.
The program that creates this file is named lilydumper, and the one that plays it is named lilyplayer.</p>
<p>The file format is made of the following:</p>
<ul>
<li>a header</li>
<li>the mapping staff number, instrument name</li>
<li>a list of events</li>
<li>the svg files</li>
</ul>
<p>And nothing else. There should be no data after the last svg file, and reader program should not accept files
with more data at the end.</p>
<a class="header" href="file_format.html#the-header" id="the-header"><h2>The header</h2></a>
<p>The first four bytes of the file are a magic number and must match <code>LPYP</code> in ascii. That is a lilydumper file
must start by <code>0x4c 0x50 0x59 0x50</code>.
The next byte is a version number. It was meant to provide backward compatibility in case new of new features
that would end up in the file format. For now it is basically <code>0x00</code>. Any other value is unknown.</p>
<a class="header" href="file_format.html#mapping-staff-number-instrument-name" id="mapping-staff-number-instrument-name"><h2>Mapping staff number, instrument name</h2></a>
<p>Immediately follwoing the header, comes the instrument names mapping as described in <a href="./finding_the_staff_instrument_name.md">its own
chapter</a>.  First there is one byte that tells how many instrument
names there is to come. This will likely be <code>0x02</code> because a piano sheet music has most of the times two
staves. Then comes the names of each staff written as utf-8 null-terminated string. The first string is the
name of the staff number 0, the second one is for the staff number 1 and so forth.</p>
<p>An example here could be: <code>0x02 0x50 0x69 0x61 0x6e 0x6f 0x00 0x50 0x69 0x610x6e 0x6f 0x00</code>. The first <code>0x02</code>
means there are two names coming which are <code>Piano</code> (0x50 0x69 0x61 0x6e 0x6f 0x00) and <code>Piano</code> again.</p>
<a class="header" href="file_format.html#the-events" id="the-events"><h2>The events</h2></a>
<p>Events occuring at the same time are grouped together, forming a group of events.  The events section of the
file starts by the number of group of events. This number is stored in 8 bytes as a big endian value. Then there
are that number of group of events appearing right after.</p>
<p>Group of events are written out sequentially, in chronological order.</p>
<p>Each group of events is written as follow:</p>
<ol>
<li>time of occurrence in nanoseconds from the start of the song (8bytes big endian)</li>
<li>number of events occurring at that time (1byte)</li>
<li>followed by each event occuring at that time.</li>
</ol>
<p>There are five different types of event so far. Each of them has a specified output format. The way they are
written is described below:</p>
<ol>
<li>id of event (1byte)</li>
<li>event-specific data</li>
</ol>
<p>Below is the table of event-id</p>
<table><thead><tr><th> event         </th><th> value </th></tr></thead><tbody>
<tr><td> press key      </td><td>     0 </td></tr>
<tr><td> release key    </td><td>     1 </td></tr>
<tr><td> set bar number </td><td>     2 </td></tr>
<tr><td> set cursor     </td><td>     3 </td></tr>
<tr><td> set svg file   </td><td>     4 </td></tr>
</tbody></table>
<p>The event-specific data is:</p>
<p><strong>for press key event</strong></p>
<ol>
<li>pitch to play (1 byte)</li>
<li>staff number  (1 byte)  (staff number on which the note appears on the music sheet)</li>
</ol>
<p><strong>for release key event</strong></p>
<ol>
<li>pitch to release (one byte)</li>
</ol>
<p><strong>for set bar number</strong></p>
<ol>
<li>the new bar/measure number (2 bytes, Big endian) (this is the current measure in the music sheet)</li>
</ol>
<p><strong>for set cursor</strong></p>
<ol>
<li>the left coordinate of the cursor box (4bytes BE)</li>
<li>the right coordinate (4bytes BE)</li>
<li>the top coordinate (4bytes BE)</li>
<li>the bottom coordinate (4bytes BE)</li>
</ol>
<p>These coordinate are stored in the file as integer but must be divided by 10.000 to use. For example, a set cursor
event with the following values in the file</p>
<table><thead><tr><th> postition </th><th> value </th></tr></thead><tbody>
<tr><td> left </td><td> 520608 </td></tr>
<tr><td> right </td><td> 750000 </td></tr>
<tr><td> top </td><td> 1234567 </td></tr>
<tr><td> bottom </td><td> 2345678 </td></tr>
</tbody></table>
<p>means the reader program must use create the following rectange as svg:</p>
<pre><code class="language-svg">&lt;rect x=&quot;52.0608&quot; y=&quot;123.4567&quot; width=&quot;22.9392&quot; height=&quot;111.1111/&gt;
</code></pre>
<p>Also note that point(0.0) means top left corner and point(5, 10) is 5 units on the right and 10 below.
Therefore, the right value of the cursor box is always bigger than the left value. Same goes for the
bottom value which is also always bigger than the top value.</p>
<p><strong>for set svg file</strong></p>
<ol>
<li>the number of the svg file to be displayed now (2bytes BE)</li>
</ol>
<p>Note that the svg files are 0-indexed. A value of 0 means the first page. 1 means the second page and so on.</p>
<a class="header" href="file_format.html#the-svgs-section" id="the-svgs-section"><h2>The svgs section</h2></a>
<p>This section is made of:</p>
<ol>
<li>the number of svg files the music contains. (two bytes, big endian)</li>
<li>For each of the svg file:</li>
<li>four bytes (big endian) telling the size in bytes of the svg file.</li>
<li>the content of that svg file.</li>
</ol>
<p>The svg files are stored in the list in order of appearance. Therefore the first one if the file
is the first page (page number zero for the turn-page event).</p>
<blockquote>
<p>This chapter could be summed up as &quot;If I had to do it again, I would simply use Cap'n Proto&quot;.</p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="finding_the_staff_instrument_name.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="possible_improvements.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="finding_the_staff_instrument_name.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="possible_improvements.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        

        
        <script src="searchindex.js" type="text/javascript" charset="utf-8"></script>
        
        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

    </body>
</html>
